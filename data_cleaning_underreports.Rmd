---
title: "ImportUnderreports"
author: "Mustapha Mustapha"
date: "2023-04-06"
output: html_document
---
## This is a document that imports uunderreports data from IHME

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# April 2023: Undercounting COVID Cases
# clear R's brain
rm( list = ls())
# load libraries
preq = c( "dplyr", "ggplot2", "ggfortify", "readxl", "readstata13", 
          "readr", "stats", "tidyverse", "haven", "Matrix", "foreign", "zoo")
#for (y in preq) install.packages(y, dep = TRUE)
sapply(preq, library, character.only=T)

# Set the directory where the files are located
setwd("G:/My\ Drive/Documents/R_github/underreporting")
```

##Import IHME Data
```{r IHME_import, echo=TRUE}
# Create a list of the file names
files <- list.files(path = "../Data/IHME/",  pattern = ".csv")
# Use grep() function to select strings starting with "myfile"
selected <- files[grep("^data_download", files)]
selected <- week <- paste( "../Data/IHME/", selected, sep="")
# View the selected strings
selected
# Read in the files and store in a list
data_list <- lapply(selected, read.csv)
View(data_list[[1]])
#lapply(data_list, colnames)
#check if all columns are identical
all(colnames(data_list[[1]]) == colnames(data_list[[2]])) ==
  all(colnames(data_list[[1]]) == colnames(data_list[[3]]))
# Bind the data frames into a single data frame
data_stack <- do.call(rbind, data_list)
View(data_stack)
```

```{r IHME_clean, echo=TRUE}
# need to make sure Georgia, USA is not mixed up with Republic of Georgia
data_stack[["location_name"]] %>% unique() %>% sort() %>% table() %>% View()
# Calculate column C = A/B only if A and B are both non-missing and not zero
data_under <- data_stack %>%
  mutate(
    under_report = 
      ifelse(!is.na(inf_mean) & inf_mean != 0 & !is.na(cases_mean) & 
        cases_mean != 0, cases_mean/inf_mean, NA)
    ) %>% 

 # Create a column for the 7 day moving average of sales for each location using zoo::rollapplyr
  group_by(location_name) %>%
  mutate(
    inf_mean_7d = rollapplyr(inf_mean, 7, mean, fill = NA, align = "right"),
    cases_mean_7d = rollapplyr(cases_mean, 7, mean, fill = NA, align = "right")
    ) %>%
  select(location_name, date, inf_mean, inf_mean_7d, cases_mean, cases_mean_7d) %>%
  filter((inf_mean) != 0) %>%
  #filter((cases_mean + inf_mean) == 0, na.rm = TRUE) %>%
  View()

 # Create a column for the 7 day moving average of sales for each location
df_ma <- df %>%
  group_by(location) %>%
  mutate(ma_sales = zoo::rollapplyr(sales, 7, mean, fill = NA, align = "right"))

# View the data frame with the new column
df_ma
 data_under %>%
  select(location_name, date, cases_mean, inf_mean) %>% 
  filter(inf_mean == 0) %>%
  select(location_name) %>%
  #table() %>% 
  View()

  summarize(missing_cases = sum(cases_mean ==0),
            missing_inf = sum(inf_mean ==0) )

View(x)


# Count missing values in each column
missing_counts <- df %>%
  summarize_all(~sum(is.na(.)))

data_under %>% 
  #filter(grepl('Macao', location_name)) %>% 
  select(location_name) %>% 
  #View() %>%
  #remove everything in parentheses
  mutate(location_clean = gsub("\\ \\(.*\\)", "", location_name)) %>%
  mutate(location_clean = gsub("^Macao.*", "Macao", location_name)) %>%
  select(location_clean) %>% table() %>% View()


```
## Group IHME data by location and calculate summary statistics
```{r summary_table}
# 1) for each location summarize Max date, min date, mean, median, max, min, upper and lower quartile
summary_table <- data_under %>% 
  filter(!is.na(inf_mean))
  group_by(location_name) %>%
  summarize(
    n = sum(!is.na(inf_mean)),
    min_date = min(as.Date(date), na.rm = TRUE),
    max_date = max(as.Date(date), na.rm = TRUE),
    mean = mean(under_report, na.rm = TRUE),
    max = max(under_report, na.rm = TRUE),
    min = min(under_report, na.rm = TRUE),
    median = median(under_report, na.rm = TRUE),
    upper_quartile = quantile(under_report, 0.75,na.rm = TRUE),
    lower_quartile = quantile(under_report, 0.25, na.rm = TRUE)
  )

# View the resulting summary table
View(summary_table)
```


## Including Plots



You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this: