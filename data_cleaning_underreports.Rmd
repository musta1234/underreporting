---
title: "ImportUnderreports"
author: "Mustapha Mustapha"
date: "2023-04-06"
output: html_document
---
## This is a document that imports uunderreports data from IHME

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# April 2023: Undercounting COVID Cases
# clear R's brain
rm( list = ls())
# load libraries
preq = c( "dplyr", "ggplot2", "ggfortify", "readxl", "readstata13", 
          "readr", "stats", "tidyverse", "haven", "Matrix", "foreign")
#for (y in preq) install.packages(y, dep = TRUE)
sapply(preq, library, character.only=T)

# Set the directory where the files are located
setwd("G:/My\ Drive/Documents/R_github/underreporting")
```

##Import IHME Data
```{r IHME_import, echo=TRUE}
# Create a list of the file names
files <- list.files(path = "../Data/IHME/",  pattern = ".csv")
# Use grep() function to select strings starting with "myfile"
selected <- files[grep("^data_download", files)]
selected <- week <- paste( "../Data/IHME/", selected, sep="")
# View the selected strings
selected
# Read in the files and store in a list
data_list <- lapply(selected, read.csv)
View(data_list[[1]])
#lapply(data_list, colnames)
#check if all columns are identical
all(colnames(data_list[[1]]) == colnames(data_list[[2]])) ==
  all(colnames(data_list[[1]]) == colnames(data_list[[3]]))
# Bind the data frames into a single data frame
data_stack <- do.call(rbind, data_list)
View(data_stack)
```

##Clean up IHME location names
```{r IHME_clean, echo=TRUE}
# need to make sure Georgia, USA is not mixed up with Republic of Georgia
data_stack[["location_name"]] %>% unique() %>% sort()
# Calculate column C = A/B only if A and B are both non-missing and not zero
data_under <- data_stack %>%
  mutate(
    under_report = 
      ifelse(
        !is.na(inf_mean) & inf_mean != 0 & !is.na(cases_mean) & 
        cases_mean != 0, inf_mean/cases_mean, NA)
    )


```
```{r summary_table}
To do:
# 1)  for each location
# 2) summarize Max date, min date, mean, median, max, min, upper and lower quartile for each location
# 3) Generate table with #1 and #2 above
# Group the data by location and calculate summary statistics
summary_table <- data_under %>% 
  filter(!is.na(inf_mean))
  group_by(location_name) %>%
  summarize(
    n = sum(!is.na(inf_mean)),
    min_date = min(as.Date(date), na.rm = TRUE),
    max_date = max(as.Date(date), na.rm = TRUE),
    mean = mean(under_report, na.rm = TRUE),
    max = max(under_report, na.rm = TRUE),
    min = min(under_report, na.rm = TRUE),
    median = median(under_report, na.rm = TRUE),
    upper_quartile = quantile(under_report, 0.75,na.rm = TRUE),
    lower_quartile = quantile(under_report, 0.25, na.rm = TRUE)
  )

# View the resulting summary table
View(summary_table)
```

## Including Plots



You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this: